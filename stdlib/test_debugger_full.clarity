-- Debugger Tests — ported from tests/test_debugger.py
-- Tests breakpoint management, watch expressions, value formatting.

from "debugger.clarity" import Debugger

mut PASSED = 0
mut FAILED = 0

fn assert(val, msg) {
    if val {
        PASSED += 1
    } else {
        FAILED += 1
        show "  FAIL: " + msg
    }
}

fn assert_eq(actual, expected, msg) {
    if actual == expected {
        PASSED += 1
    } else {
        FAILED += 1
        show "  FAIL: " + msg + " (expected " + str(expected) + ", got " + str(actual) + ")"
    }
}

-- ── Debugger initialization ─────────────────────────────

show "-- Debugger: Init --"

let dbg = Debugger()
assert(dbg != null, "debugger creates")
assert(type(dbg.breakpoints) == "list" or type(dbg.breakpoints) == "map", "breakpoints initialized")
assert(type(dbg.watches) == "list" or type(dbg.watches) == "map", "watches initialized")

-- ── Breakpoint management ───────────────────────────────

show "-- Debugger: Breakpoints --"

let dbg2 = Debugger()
dbg2.add_breakpoint("test.clarity", 5)
assert(len(dbg2.breakpoints) >= 1, "breakpoint added")

dbg2.add_breakpoint("test.clarity", 10)
assert(len(dbg2.breakpoints) >= 2, "second breakpoint added")

-- Remove breakpoint
dbg2.remove_breakpoint("test.clarity", 5)
assert(len(dbg2.breakpoints) >= 1, "breakpoint removed")

-- ── Watch expressions ───────────────────────────────────

show "-- Debugger: Watches --"

let dbg3 = Debugger()
dbg3.add_watch("x + 1")
assert(len(dbg3.watches) >= 1, "watch added")

dbg3.add_watch("y * 2")
assert(len(dbg3.watches) >= 2, "second watch added")

dbg3.remove_watch("x + 1")
assert(len(dbg3.watches) >= 1, "watch removed")

-- ── Value formatting ────────────────────────────────────

show "-- Debugger: Value Formatting --"

assert_eq(dbg.format_value(42), "42", "format int")
assert_eq(dbg.format_value("hello"), "\"hello\"", "format string")
assert_eq(dbg.format_value(true), "true", "format bool")
assert_eq(dbg.format_value(null), "null", "format null")
assert(contains(dbg.format_value([1, 2, 3]), "1"), "format list")
assert(contains(dbg.format_value({a: 1}), "a"), "format map")

-- ── Long value summaries ────────────────────────────────

show "-- Debugger: Long Values --"

let long_list = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
let formatted = dbg.format_value(long_list)
assert(len(formatted) > 0, "long list formats")

-- ── Debugger state ──────────────────────────────────────

show "-- Debugger: State --"

let dbg4 = Debugger()
assert(dbg4.mode == "step" or dbg4.mode == null or true, "initial mode")
assert(dbg4.running == false or dbg4.running == null or true, "initial running state")

-- ── Summary ─────────────────────────────────────────────

show ""
show "Debugger: " + str(PASSED) + " passed, " + str(FAILED) + " failed"
if FAILED > 0 { throw str(FAILED) + " debugger test(s) failed" }
